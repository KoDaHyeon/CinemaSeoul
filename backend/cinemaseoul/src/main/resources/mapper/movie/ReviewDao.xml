<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.uos.cinemaseoul.dao.movie.ReviewDao">

    <!--[insert REv]-->
    <insert id="insertReview" parameterType="ReviewVo">
        INSERT INTO REVIEW (MOVI_ID, USER_ID, RATING, COMMENTS) VALUES
        (#{movi_id},#{user_id},#{rating},#{comments})
    </insert>

    <update id="updateReview" parameterType="ReviewVo">
        UPDATE REVIEW SET RATING = #{rating}, COMMENTS = #{commnets}
        WHERE MOVI_ID = #{movi_id} AND USER_ID = #{user_id}
    </update>

    <delete id="deleteReview" parameterType="ReviewVo">
        DELETE REVIEW WHERE MOVI_ID = #{movi_id} AND USER_ID = #{user_id}
    </delete>

    <update id="updateMovieRating">
        UPDATE MOVIE SET RATING =
            (SELECT SUM(R.RATING)/COUNT(R.RATING) FROM REVIEW R WHERE MOVI_ID = #{movi_id})
    </update>

    <select id="selectMyMovie" resultType="MovieReviewDto">
        SELECT R.COMMENTS, R.RATING,
               M.MOVI_ID, M.MOVI_NAME, M.IMAGE
        FROM BOOK B
        RIGHT OUTER JOIN MOVIE M ON M.MOVI_ID = B.MOVI_ID
        INNER JOIN REVIEW R ON R.USER_ID = B.USER_ID
        WHERE B.USER_ID = {user_id}
    </select>
</mapper>